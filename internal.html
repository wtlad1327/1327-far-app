<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>內部學習平台 – 急救學習</title>
  <link rel="manifest" href="manifest.json"/>
  <link rel="stylesheet" href="css/style.css"/>
  <link rel="stylesheet" href="css/internal.css"/>
</head>
<body>

  <!-- 登入畫面 -->
  <div id="login-screen" class="login-screen">
    <div class="login-card">
      <div class="login-logo">🚑</div>
      <h1>內部學習平台</h1>
      <p class="login-subtitle">請登入你的帳戶</p>

      <div id="login-error" class="error-msg" style="display:none"></div>

      <div class="form-group">
        <label>電郵地址</label>
        <input type="email" id="email-input" placeholder="yourname@email.com"/>
      </div>
      <div class="form-group">
        <label>密碼</label>
        <input type="password" id="password-input" placeholder="輸入密碼"/>
      </div>
      <button class="btn-login" id="login-btn" onclick="loginWithEmail()">登入</button>

      <div class="divider">或</div>

      <button class="btn-google" onclick="loginWithGoogle()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"/> 
        用 Google 帳號登入
      </button>

      <p class="login-note">只限已獲授權的成員登入<br/>如需帳戶請聯絡管理員</p>
    </div>
  </div>

  <!-- 主介面（登入後顯示）-->
  <div id="main-screen" style="display:none">

    <nav class="navbar">
      <div class="nav-brand">🚑 急救學習平台（內部）</div>
      <div class="nav-right">
        <span id="user-name" class="user-name"></span>
        <button onclick="logout()" class="btn-logout">登出</button>
      </div>
    </nav>

    <!-- 學習進度總覽 -->
    <section class="dashboard">
      <h2>我的學習進度</h2>
      <div class="progress-grid">
        <div class="progress-card">
          <div class="progress-icon">🫀</div>
          <h3>身體系統</h3>
          <div class="progress-bar"><div class="progress-fill" id="prog-body"></div></div>
          <span id="prog-body-text">0%</span>
        </div>
        <div class="progress-card">
          <div class="progress-icon">🚨</div>
          <h3>急救基礎</h3>
          <div class="progress-bar"><div class="progress-fill" id="prog-firstaid"></div></div>
          <span id="prog-firstaid-text">0%</span>
        </div>
        <div class="progress-card">
          <div class="progress-icon">⚡</div>
          <h3>去顫法 AED</h3>
          <div class="progress-bar"><div class="progress-fill" id="prog-aed"></div></div>
          <span id="prog-aed-text">0%</span>
        </div>
        <div class="progress-card">
          <div class="progress-icon">🏠</div>
          <h3>家居護理</h3>
          <div class="progress-bar"><div class="progress-fill" id="prog-homecare"></div></div>
          <span id="prog-homecare-text">0%</span>
        </div>
      </div>
    </section>

    <!-- 閃卡練習 -->
    <section class="flashcard-section">
      <h2>閃卡練習</h2>
      <p class="subtitle">點擊卡片翻面 · 進度自動儲存</p>
      <div class="flashcard-container">
        <div class="flashcard" id="flashcard" onclick="flipCard()">
          <div class="flashcard-front">
            <span class="card-label">詞彙</span>
            <h3 id="card-term">載入中...</h3>
          </div>
          <div class="flashcard-back">
            <span class="card-label">解釋</span>
            <p id="card-definition">載入中...</p>
          </div>
        </div>
      </div>
      <div class="flashcard-controls">
        <button onclick="prevCard()" class="btn-secondary">← 上一張</button>
        <span id="card-counter">1 / 1</span>
        <button onclick="nextCard()" class="btn-secondary">下一張 →</button>
      </div>
      <div class="card-actions">
        <button onclick="markKnown()" class="btn-known">✅ 已掌握</button>
        <button onclick="markReview()" class="btn-review">🔁 需複習</button>
      </div>
    </section>

    <!-- 測驗模組 -->
    <section class="quiz-section">
      <h2>情境測驗</h2>
      <div id="quiz-container">
        <div class="quiz-card" id="quiz-card">
          <p id="quiz-question">載入中...</p>
          <div id="quiz-options" class="quiz-options"></div>
          <div id="quiz-result" class="quiz-result" style="display:none"></div>
          <button id="quiz-next" onclick="nextQuestion()" style="display:none" class="btn-secondary">下一題 →</button>
        </div>
        <div class="quiz-score">
          <span>得分：</span><span id="quiz-score">0</span>
          <span> / </span><span id="quiz-total">0</span>
        </div>
      </div>
    </section>

  </div>

  <script type="module">
    import { auth, db } from './js/firebase-config.js';
    import {
      signInWithEmailAndPassword,
      signInWithPopup,
      GoogleAuthProvider,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import {
      doc, getDoc, setDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const provider = new GoogleAuthProvider();

    // 閃卡資料
    const cards = [
      { term: "心臟 Heart", definition: "位於胸腔中央偏左，負責將血液泵送至全身。" },
      { term: "肺 Lung", definition: "左右各一，負責吸入氧氣及排出二氧化碳。" },
      { term: "動脈 Artery", definition: "將含氧血液從心臟輸送到全身各部位的血管。" },
      { term: "靜脈 Vein", definition: "將身體各部位的血液送回心臟的血管。" },
      { term: "大腦 Brain", definition: "神經系統的控制中心，負責思考、記憶及感覺。" },
      { term: "CPR 心肺復甦法", definition: "心臟停頓時，用胸外壓及人工呼吸維持血液循環。" },
      { term: "AED 自動體外除顫器", definition: "自動分析心律並施以電擊的儀器，用於心室纖顫搶救。" },
      { term: "橫膈膜 Diaphragm", definition: "位於胸腔底部的肌肉，控制呼吸運動。" }
    ];

    // 測驗題目
    const quizQuestions = [
      {
        question: "見到有人突然暈倒，你第一步應該做咩？",
        options: ["立即做CPR", "確認現場安全並評估意識", "立即打999", "搬移傷者"],
        answer: 1,
        explanation: "正確！首先確保現場安全，然後輕拍肩膀評估意識，再決定下一步。"
      },
      {
        question: "使用AED時，貼上電極片後應該點做？",
        options: ["立即按電擊掣", "繼續做CPR", "讓AED自動分析心律，期間所有人勿接觸傷者", "移除電極片"],
        answer: 2,
        explanation: "正確！AED分析期間所有人必須離開傷者，等待AED指示才可按電擊。"
      },
      {
        question: "正常成人靜止心跳率係？",
        options: ["30-50次/分鐘", "60-100次/分鐘", "100-120次/分鐘", "120-140次/分鐘"],
        answer: 1,
        explanation: "正確！正常成人靜止心跳率為每分鐘60-100次。"
      },
      {
        question: "處理傷口時，正確步驟係？",
        options: ["直接包紮", "用清水沖洗→消毒→包紮", "只用消毒藥水", "用布抹乾淨"],
        answer: 1,
        explanation: "正確！先用清水沖洗去除異物，再消毒，最後包紮。"
      }
    ];

    let currentCard = 0;
    let currentQuestion = 0;
    let score = 0;
    let totalAnswered = 0;
    let userId = null;
    let userProgress = {};

    // 監聽登入狀態
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userId = user.uid;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-screen').style.display = 'block';
        document.getElementById('user-name').textContent = user.displayName || user.email;
        await loadProgress();
        updateCard();
        loadQuestion();
      } else {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('main-screen').style.display = 'none';
      }
    });

    // 載入進度
    async function loadProgress() {
      const ref = doc(db, 'users', userId);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        userProgress = snap.data().progress || {};
        updateProgressBars();
      }
    }

    // 更新進度條
    function updateProgressBars() {
      const modules = ['body', 'firstaid', 'aed', 'homecare'];
      modules.forEach(m => {
        const pct = userProgress[m] || 0;
        document.getElementById(`prog-${m}`).style.width = pct + '%';
        document.getElementById(`prog-${m}-text`).textContent = pct + '%';
      });
    }

    // 儲存進度
    async function saveProgress() {
      const ref = doc(db, 'users', userId);
      await setDoc(ref, { progress: userProgress, email: auth.currentUser.email }, { merge: true });
    }

    // 閃卡功能
    function updateCard() {
      const card = cards[currentCard];
      document.getElementById('card-term').textContent = card.term;
      document.getElementById('card-definition').textContent = card.definition;
      document.getElementById('card-counter').textContent = `${currentCard + 1} / ${cards.length}`;
      document.getElementById('flashcard').classList.remove('flipped');
    }

    window.flipCard = () => document.getElementById('flashcard').classList.toggle('flipped');
    window.nextCard = () => { currentCard = (currentCard + 1) % cards.length; updateCard(); };
    window.prevCard = () => { currentCard = (currentCard - 1 + cards.length) % cards.length; updateCard(); };

    window.markKnown = async () => {
      userProgress['body'] = Math.min(100, (userProgress['body'] || 0) + 10);
      updateProgressBars();
      await saveProgress();
      window.nextCard();
    };

    window.markReview = () => window.nextCard();

    // 測驗功能
    function loadQuestion() {
      if (currentQuestion >= quizQuestions.length) {
        document.getElementById('quiz-card').innerHTML = `
          <div style="text-align:center;padding:2rem">
            <div style="font-size:3rem">🎉</div>
            <h3>測驗完成！</h3>
            <p>你答對了 ${score} / ${quizQuestions.length} 題</p>
            <button onclick="resetQuiz()" class="btn-primary" style="margin-top:1rem">重新測驗</button>
          </div>`;
        return;
      }
      const q = quizQuestions[currentQuestion];
      document.getElementById('quiz-question').textContent = q.question;
      document.getElementById('quiz-result').style.display = 'none';
      document.getElementById('quiz-next').style.display = 'none';
      const optionsDiv = document.getElementById('quiz-options');
      optionsDiv.innerHTML = '';
      q.options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'quiz-option';
        btn.textContent = opt;
        btn.onclick = () => answerQuestion(i);
        optionsDiv.appendChild(btn);
      });
    }

    window.answerQuestion = async (selected) => {
      const q = quizQuestions[currentQuestion];
      const resultDiv = document.getElementById('quiz-result');
      const options = document.querySelectorAll('.quiz-option');
      options.forEach(btn => btn.disabled = true);
      options[q.answer].classList.add('correct');

      if (selected === q.answer) {
        score++;
        resultDiv.innerHTML = `✅ ${q.explanation}`;
        resultDiv.className = 'quiz-result correct-result';
        options[selected].classList.add('correct');
        userProgress['firstaid'] = Math.min(100, (userProgress['firstaid'] || 0) + 15);
      } else {
        resultDiv.innerHTML = `❌ ${q.explanation}`;
        resultDiv.className = 'quiz-result wrong-result';
        options[selected].classList.add('wrong');
      }

      totalAnswered++;
      document.getElementById('quiz-score').textContent = score;
      document.getElementById('quiz-total').textContent = totalAnswered;
      resultDiv.style.display = 'block';
      document.getElementById('quiz-next').style.display = 'inline-block';
      updateProgressBars();
      await saveProgress();
    };

    window.nextQuestion = () => { currentQuestion++; loadQuestion(); };

    window.resetQuiz = () => {
      currentQuestion = 0; score = 0; totalAnswered = 0;
      document.getElementById('quiz-score').textContent = 0;
      document.getElementById('quiz-total').textContent = 0;
      loadQuestion();
    };

    // 登入功能
    window.loginWithEmail = async () => {
      const email = document.getElementById('email-input').value;
      const password = document.getElementById('password-input').value;
      const errDiv = document.getElementById('login-error');
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (e) {
        errDiv.style.display = 'block';
        errDiv.textContent = '登入失敗：電郵或密碼錯誤';
      }
    };

    window.loginWithGoogle = async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        document.getElementById('login-error').style.display = 'block';
        document.getElementById('login-error').textContent = '登入失敗，請再試';
      }
    };

    window.logout = () => signOut(auth);
  </script>
</body>
</html>
