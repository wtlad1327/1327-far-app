<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç®¡ç†å¾Œå° â€“ æ€¥æ•‘å­¸ç¿’å¹³å°</title>
  <link rel="stylesheet" href="css/style.css"/>
  <link rel="stylesheet" href="css/internal.css"/>
  <link rel="stylesheet" href="css/admin.css"/>
</head>
<body>

  <!-- ç®¡ç†å“¡ç™»å…¥ -->
  <div id="login-screen" class="login-screen">
    <div class="login-card">
      <div class="login-logo">ğŸ› ï¸</div>
      <h1>ç®¡ç†å“¡å¾Œå°</h1>
      <p class="login-subtitle">åªé™æˆæ¬Šç®¡ç†å“¡ç™»å…¥</p>
      <div id="login-error" class="error-msg" style="display:none"></div>
      <div class="form-group">
        <label>é›»éƒµåœ°å€</label>
        <input type="email" id="email-input" placeholder="admin@email.com"/>
      </div>
      <div class="form-group">
        <label>å¯†ç¢¼</label>
        <input type="password" id="password-input" placeholder="è¼¸å…¥å¯†ç¢¼"/>
      </div>
      <button class="btn-login" onclick="adminLogin()">ç™»å…¥å¾Œå°</button>
    </div>
  </div>

  <!-- å¾Œå°ä¸»ä»‹é¢ -->
  <div id="admin-screen" style="display:none">
    <nav class="navbar">
      <div class="nav-brand">ğŸ› ï¸ ç®¡ç†å¾Œå°</div>
      <div class="nav-right">
        <a href="index.html" style="color:white;font-size:0.85rem">â† è¿”å›ä¸»é </a>
        <button onclick="adminLogout()" class="btn-logout">ç™»å‡º</button>
      </div>
    </nav>

    <!-- åˆ†é åˆ‡æ› -->
    <div class="admin-tabs">
      <button class="tab-btn active" onclick="switchTab('users')">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</button>
      <button class="tab-btn" onclick="switchTab('cards')">ğŸ“š é–ƒå¡ç®¡ç†</button>
      <button class="tab-btn" onclick="switchTab('quiz')">ğŸ§  æ¸¬é©—ç®¡ç†</button>
    </div>

    <!-- ç”¨æˆ¶ç®¡ç† -->
    <div id="tab-users" class="tab-content">
      <div class="admin-section">
        <div class="section-header">
          <h2>ç”¨æˆ¶ç®¡ç†</h2>
          <button onclick="showAddUser()" class="btn-add">+ æ–°å¢ç”¨æˆ¶</button>
        </div>

        <!-- æ–°å¢ç”¨æˆ¶è¡¨å–® -->
        <div id="add-user-form" class="add-form" style="display:none">
          <h3>æ–°å¢ç”¨æˆ¶</h3>
          <div class="form-row">
            <div class="form-group">
              <label>é›»éƒµåœ°å€</label>
              <input type="email" id="new-email" placeholder="user@email.com"/>
            </div>
            <div class="form-group">
              <label>è‡¨æ™‚å¯†ç¢¼</label>
              <input type="password" id="new-password" placeholder="æœ€å°‘6ä½"/>
            </div>
          </div>
          <button onclick="createUser()" class="btn-login" style="width:auto;padding:0.6rem 1.5rem">å»ºç«‹å¸³æˆ¶</button>
          <button onclick="hideAddUser()" class="btn-secondary" style="margin-left:0.5rem">å–æ¶ˆ</button>
          <div id="create-msg" style="margin-top:0.5rem;font-size:0.85rem"></div>
        </div>

        <!-- ç”¨æˆ¶åˆ—è¡¨ -->
        <div id="users-list" class="data-table">
          <p style="color:#888;text-align:center;padding:2rem">è¼‰å…¥ä¸­...</p>
        </div>
      </div>
    </div>

    <!-- é–ƒå¡ç®¡ç† -->
    <div id="tab-cards" class="tab-content" style="display:none">
      <div class="admin-section">
        <div class="section-header">
          <h2>é–ƒå¡ç®¡ç†</h2>
          <button onclick="showAddCard()" class="btn-add">+ æ–°å¢é–ƒå¡</button>
        </div>

        <div id="add-card-form" class="add-form" style="display:none">
          <h3>æ–°å¢é–ƒå¡</h3>
          <div class="form-group">
            <label>è©å½™ï¼ˆæ­£é¢ï¼‰</label>
            <input type="text" id="new-term" placeholder="ä¾‹ï¼šå¿ƒè‡Ÿ Heart"/>
          </div>
          <div class="form-group">
            <label>è§£é‡‹ï¼ˆèƒŒé¢ï¼‰</label>
            <textarea id="new-definition" placeholder="ç°¡å–®è§£é‡‹è©å½™æ„æ€..." rows="3"></textarea>
          </div>
          <div class="form-group">
            <label>åˆ†é¡</label>
            <select id="new-category">
              <option value="anatomy">è§£å‰–å­¸è©å½™</option>
              <option value="firstaid">æ€¥æ•‘</option>
              <option value="homecare">å®¶å±…è­·ç†</option>
            </select>
          </div>
          <button onclick="addCard()" class="btn-login" style="width:auto;padding:0.6rem 1.5rem">æ–°å¢</button>
          <button onclick="hideAddCard()" class="btn-secondary" style="margin-left:0.5rem">å–æ¶ˆ</button>
        </div>

        <div id="cards-list" class="data-table">
          <p style="color:#888;text-align:center;padding:2rem">è¼‰å…¥ä¸­...</p>
        </div>
      </div>
    </div>

    <!-- æ¸¬é©—ç®¡ç† -->
    <div id="tab-quiz" class="tab-content" style="display:none">
      <div class="admin-section">
        <div class="section-header">
          <h2>æ¸¬é©—é¡Œç›®ç®¡ç†</h2>
          <button onclick="showAddQuiz()" class="btn-add">+ æ–°å¢é¡Œç›®</button>
        </div>

        <div id="add-quiz-form" class="add-form" style="display:none">
          <h3>æ–°å¢æ¸¬é©—é¡Œç›®</h3>
          <div class="form-group">
            <label>é¡Œç›®</label>
            <textarea id="new-question" placeholder="è¼¸å…¥å•é¡Œ..." rows="2"></textarea>
          </div>
          <div class="form-group">
            <label>é¸é …A</label><input type="text" id="opt-a" placeholder="é¸é …A"/>
          </div>
          <div class="form-group">
            <label>é¸é …B</label><input type="text" id="opt-b" placeholder="é¸é …B"/>
          </div>
          <div class="form-group">
            <label>é¸é …C</label><input type="text" id="opt-c" placeholder="é¸é …C"/>
          </div>
          <div class="form-group">
            <label>é¸é …D</label><input type="text" id="opt-d" placeholder="é¸é …D"/>
          </div>
          <div class="form-group">
            <label>æ­£ç¢ºç­”æ¡ˆ</label>
            <select id="correct-answer">
              <option value="0">é¸é …A</option>
              <option value="1">é¸é …B</option>
              <option value="2">é¸é …C</option>
              <option value="3">é¸é …D</option>
            </select>
          </div>
          <div class="form-group">
            <label>è§£é‡‹ï¼ˆç­”é¡Œå¾Œé¡¯ç¤ºï¼‰</label>
            <textarea id="new-explanation" placeholder="è§£é‡‹æ­£ç¢ºç­”æ¡ˆ..." rows="2"></textarea>
          </div>
          <button onclick="addQuizQuestion()" class="btn-login" style="width:auto;padding:0.6rem 1.5rem">æ–°å¢é¡Œç›®</button>
          <button onclick="hideAddQuiz()" class="btn-secondary" style="margin-left:0.5rem">å–æ¶ˆ</button>
        </div>

        <div id="quiz-list" class="data-table">
          <p style="color:#888;text-align:center;padding:2rem">è¼‰å…¥ä¸­...</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './js/firebase-config.js';
    import {
      signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import {
      collection, getDocs, addDoc, deleteDoc, doc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // ç®¡ç†å“¡ Email ç™½åå–®ï¼ˆæ›æˆä½ è‡ªå·±çš„ Emailï¼‰
    const ADMIN_EMAILS = ['wtlad1327@gmail.com','waterlooa71@gmail.com'];

    onAuthStateChanged(auth, (user) => {
      if (user && ADMIN_EMAILS.includes(user.email)) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('admin-screen').style.display = 'block';
        loadUsers();
        loadCards();
        loadQuizQuestions();
      } else if (user) {
        signOut(auth);
        showError('ä½ æ²’æœ‰ç®¡ç†å“¡æ¬Šé™');
      } else {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('admin-screen').style.display = 'none';
      }
    });

    // ç™»å…¥ç™»å‡º
    window.adminLogin = async () => {
      try {
        await signInWithEmailAndPassword(auth,
          document.getElementById('email-input').value,
          document.getElementById('password-input').value
        );
      } catch(e) { showError('ç™»å…¥å¤±æ•—ï¼šé›»éƒµæˆ–å¯†ç¢¼éŒ¯èª¤'); }
    };

    window.adminLogout = () => signOut(auth);

    function showError(msg) {
      const el = document.getElementById('login-error');
      el.style.display = 'block';
      el.textContent = msg;
    }

    // åˆ†é åˆ‡æ›
    window.switchTab = (tab) => {
      document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      document.getElementById(`tab-${tab}`).style.display = 'block';
      event.target.classList.add('active');
    };

    // ===== ç”¨æˆ¶ç®¡ç† =====
    async function loadUsers() {
      const snap = await getDocs(collection(db, 'users'));
      const list = document.getElementById('users-list');
      if (snap.empty) { list.innerHTML = '<p style="color:#888;text-align:center;padding:2rem">æš«ç„¡ç”¨æˆ¶è¨˜éŒ„</p>'; return; }
      list.innerHTML = `
        <table>
          <thead><tr><th>é›»éƒµ</th><th>èº«é«”ç³»çµ±</th><th>æ€¥æ•‘</th><th>AED</th><th>å®¶å±…è­·ç†</th></tr></thead>
          <tbody>
            ${snap.docs.map(d => {
              const data = d.data();
              const p = data.progress || {};
              return `<tr>
                <td>${data.email || d.id}</td>
                <td>${p.body || 0}%</td>
                <td>${p.firstaid || 0}%</td>
                <td>${p.aed || 0}%</td>
                <td>${p.homecare || 0}%</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>`;
    }

    window.showAddUser = () => document.getElementById('add-user-form').style.display = 'block';
    window.hideAddUser = () => document.getElementById('add-user-form').style.display = 'none';

    window.createUser = async () => {
      const msg = document.getElementById('create-msg');
      msg.textContent = 'âš ï¸ è«‹ç”¨ Firebase Console â†’ Authentication â†’ Add user æ‰‹å‹•æ–°å¢ç”¨æˆ¶ï¼Œæˆ–è®“ç”¨æˆ¶è‡ªè¡Œç”¨ Google ç™»å…¥ã€‚';
      msg.style.color = '#856404';
    };

    // ===== é–ƒå¡ç®¡ç† =====
    async function loadCards() {
      const snap = await getDocs(collection(db, 'flashcards'));
      const list = document.getElementById('cards-list');
      if (snap.empty) {
        list.innerHTML = '<p style="color:#888;text-align:center;padding:2rem">æš«ç„¡é–ƒå¡ï¼Œè«‹æ–°å¢</p>';
        return;
      }
      list.innerHTML = `
        <table>
          <thead><tr><th>è©å½™</th><th>è§£é‡‹</th><th>åˆ†é¡</th><th>æ“ä½œ</th></tr></thead>
          <tbody>
            ${snap.docs.map(d => {
              const data = d.data();
              return `<tr>
                <td>${data.term}</td>
                <td style="font-size:0.85rem;color:#666">${data.definition}</td>
                <td>${data.category || '-'}</td>
                <td><button onclick="deleteCard('${d.id}')" class="btn-delete">åˆªé™¤</button></td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>`;
    }

    window.showAddCard = () => document.getElementById('add-card-form').style.display = 'block';
    window.hideAddCard = () => document.getElementById('add-card-form').style.display = 'none';

    window.addCard = async () => {
      const term = document.getElementById('new-term').value.trim();
      const definition = document.getElementById('new-definition').value.trim();
      const category = document.getElementById('new-category').value;
      if (!term || !definition) return alert('è«‹å¡«å¯«è©å½™åŒè§£é‡‹');
      await addDoc(collection(db, 'flashcards'), { term, definition, category });
      hideAddCard();
      loadCards();
    };

    window.deleteCard = async (id) => {
      if (!confirm('ç¢ºå®šåˆªé™¤æ­¤é–ƒå¡ï¼Ÿ')) return;
      await deleteDoc(doc(db, 'flashcards', id));
      loadCards();
    };

    // ===== æ¸¬é©—ç®¡ç† =====
    async function loadQuizQuestions() {
      const snap = await getDocs(collection(db, 'quiz'));
      const list = document.getElementById('quiz-list');
      if (snap.empty) {
        list.innerHTML = '<p style="color:#888;text-align:center;padding:2rem">æš«ç„¡é¡Œç›®ï¼Œè«‹æ–°å¢</p>';
        return;
      }
      list.innerHTML = `
        <table>
          <thead><tr><th>é¡Œç›®</th><th>æ­£ç¢ºç­”æ¡ˆ</th><th>æ“ä½œ</th></tr></thead>
          <tbody>
            ${snap.docs.map(d => {
              const data = d.data();
              return `<tr>
                <td style="font-size:0.9rem">${data.question}</td>
                <td style="font-size:0.85rem;color:#28a745">${data.options?.[data.answer] || '-'}</td>
                <td><button onclick="deleteQuiz('${d.id}')" class="btn-delete">åˆªé™¤</button></td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>`;
    }

    window.showAddQuiz = () => document.getElementById('add-quiz-form').style.display = 'block';
    window.hideAddQuiz = () => document.getElementById('add-quiz-form').style.display = 'none';

    window.addQuizQuestion = async () => {
      const question = document.getElementById('new-question').value.trim();
      const options = [
        document.getElementById('opt-a').value.trim(),
        document.getElementById('opt-b').value.trim(),
        document.getElementById('opt-c').value.trim(),
        document.getElementById('opt-d').value.trim()
      ];
      const answer = parseInt(document.getElementById('correct-answer').value);
      const explanation = document.getElementById('new-explanation').value.trim();
      if (!question || options.some(o => !o)) return alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
      await addDoc(collection(db, 'quiz'), { question, options, answer, explanation });
      hideAddQuiz();
      loadQuizQuestions();
    };

    window.deleteQuiz = async (id) => {
      if (!confirm('ç¢ºå®šåˆªé™¤æ­¤é¡Œç›®ï¼Ÿ')) return;
      await deleteDoc(doc(db, 'quiz', id));
      loadQuizQuestions();
    };
  </script>
</body>
</html>
